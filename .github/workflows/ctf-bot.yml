name: CTF Flag Bot (Secure)

permissions:
  contents: write
  issues: write

on:
  issues:
    types: [opened]

jobs:
  ctf:
    runs-on: ubuntu-latest

    steps:
      # ----------------------------------
      # Checkout repository
      # ----------------------------------
      - uses: actions/checkout@v4

      # ----------------------------------
      # Extract name and flag from issue
      # ----------------------------------
      - name: Extract Issue Data
        id: extract
        run: |
          BODY="${{ github.event.issue.body }}"

          USER=$(echo "$BODY" | grep "^name:" | cut -d':' -f2 | tr -d ' ')
          FLAG=$(echo "$BODY" | grep "^flag:" | cut -d':' -f2 | tr -d ' ')

          echo "user=$USER" >> $GITHUB_OUTPUT
          echo "flag=$FLAG" >> $GITHUB_OUTPUT

      # ----------------------------------
      # Validate flag using HASHING
      # ----------------------------------
      - name: Validate Flag (Hashed)
        id: validate
        run: |
          FLAG="${{ steps.extract.outputs.flag }}"

          # Hash submitted flag
          FLAG_HASH=$(echo -n "$FLAG" | sha256sum | awk '{print $1}')

          # üîê STORED HASHES (replace with your real hashes)
          HARI_HASH="REPLACE_WITH_HASH_OF_hari"
          KRIS_HASH="REPLACE_WITH_HASH_OF_kris"
          MOZHI_HASH="REPLACE_WITH_HASH_OF_mozhi"
          VARMAN_HASH="REPLACE_WITH_HASH_OF_varman"

          if [ "$FLAG_HASH" = "$HARI_HASH" ]; then
            POINTS=10
          elif [ "$FLAG_HASH" = "$KRIS_HASH" ]; then
            POINTS=10
          elif [ "$FLAG_HASH" = "$MOZHI_HASH" ]; then
            POINTS=20
          elif [ "$FLAG_HASH" = "$VARMAN_HASH" ]; then
            POINTS=20
          else
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "valid=true" >> $GITHUB_OUTPUT
          echo "points=$POINTS" >> $GITHUB_OUTPUT

      # ----------------------------------
      # Check duplicate submission
      # ----------------------------------
      - name: Check Duplicate
        id: dup
        run: |
          USER="${{ steps.extract.outputs.user }}"
          FLAG="${{ steps.extract.outputs.flag }}"

          if grep -q "| $USER |" leaderboard.md && grep -q "$FLAG" leaderboard.md; then
            echo "dup=true" >> $GITHUB_OUTPUT
          else
            echo "dup=false" >> $GITHUB_OUTPUT
          fi

      # ----------------------------------
      # Update leaderboard
      # ----------------------------------
      - name: Update Leaderboard
        if: steps.validate.outputs.valid == 'true' && steps.dup.outputs.dup == 'false'
        run: |
          USER="${{ steps.extract.outputs.user }}"
          FLAG="${{ steps.extract.outputs.flag }}"
          POINTS="${{ steps.validate.outputs.points }}"

          if grep -q "| $USER |" leaderboard.md; then
            LINE=$(grep "| $USER |" leaderboard.md)

            OLD_POINTS=$(echo "$LINE" | cut -d'|' -f3 | tr -d ' ')
            OLD_FLAGS=$(echo "$LINE" | cut -d'|' -f4 | tr -d ' ')

            if [ -z "$OLD_POINTS" ]; then
              OLD_POINTS=0
            fi

            NEW_POINTS=$((OLD_POINTS + POINTS))

            sed -i "\|$LINE|d" leaderboard.md
            echo "| $USER | $NEW_POINTS | $OLD_FLAGS,$FLAG |" >> leaderboard.md
          else
            echo "| $USER | $POINTS | $FLAG |" >> leaderboard.md
          fi

      # ----------------------------------
      # Commit leaderboard changes
      # ----------------------------------
      - name: Commit Leaderboard
        if: steps.validate.outputs.valid == 'true' && steps.dup.outputs.dup == 'false'
        run: |
          git config user.name "ctf-bot"
          git config user.email "ctf-bot@github.com"
          git add leaderboard.md
          git commit -m "CTF: ${{ steps.extract.outputs.user }} solved a challenge"
          git push

      # ----------------------------------
      # Comment result on issue
      # ----------------------------------
      - name: Comment Result
        run: |
          if [[ "${{ steps.validate.outputs.valid }}" != "true" ]]; then
            COMMENT="‚ùå Wrong flag. Try again."
          elif [[ "${{ steps.dup.outputs.dup }}" == "true" ]]; then
            COMMENT="‚ö†Ô∏è Flag already submitted."
          else
            COMMENT="‚úÖ Correct flag! Points added to leaderboard."
          fi

          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            -d "{\"body\":\"$COMMENT\"}"

      # ----------------------------------
      # Close the issue
      # ----------------------------------
      - name: Close Issue
        run: |
          curl -X PATCH \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }} \
            -d '{"state":"closed"}'
