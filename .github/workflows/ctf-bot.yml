name: CTF Flag Bot

permissions:
  contents: write
  issues: write

on:
  issues:
    types: [opened]

jobs:
  ctf:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # Checkout repository
      # -----------------------------
      - uses: actions/checkout@v4

      # -----------------------------
      # Extract user and flag
      # -----------------------------
      - name: Extract Issue Data
        id: extract
        run: |
          BODY="${{ github.event.issue.body }}"

          USER=$(echo "$BODY" | grep "^name:" | cut -d':' -f2 | tr -d ' ')
          FLAG=$(echo "$BODY" | grep "^flag:" | cut -d':' -f2 | tr -d ' ')

          echo "user=$USER" >> $GITHUB_OUTPUT
          echo "flag=$FLAG" >> $GITHUB_OUTPUT

      # -----------------------------
      # Validate flag and assign points
      # -----------------------------
      - name: Validate Flag
        id: validate
        run: |
          FLAG="${{ steps.extract.outputs.flag }}"

          case "$FLAG" in
            hari) POINTS=10 ;;
            kris) POINTS=10 ;;
            mozhi) POINTS=20 ;;
            varman) POINTS=20 ;;
            *)
              echo "valid=false" >> $GITHUB_OUTPUT
              exit 0
              ;;
          esac

          echo "valid=true" >> $GITHUB_OUTPUT
          echo "points=$POINTS" >> $GITHUB_OUTPUT

      # -----------------------------
      # Check duplicate flag
      # -----------------------------
      - name: Check Duplicate
        id: dup
        run: |
          USER="${{ steps.extract.outputs.user }}"
          FLAG="${{ steps.extract.outputs.flag }}"

          if grep -q "| $USER |" leaderboard.md && grep -q "$FLAG" leaderboard.md; then
            echo "dup=true" >> $GITHUB_OUTPUT
          else
            echo "dup=false" >> $GITHUB_OUTPUT
          fi

      # -----------------------------
      # Update leaderboard safely
      # -----------------------------
      - name: Update Leaderboard
        if: steps.validate.outputs.valid == 'true' && steps.dup.outputs.dup == 'false'
        run: |
          USER="${{ steps.extract.outputs.user }}"
          FLAG="${{ steps.extract.outputs.flag }}"
          POINTS="${{ steps.validate.outputs.points }}"

          if grep -q "| $USER |" leaderboard.md; then
            LINE=$(grep "| $USER |" leaderboard.md)

            OLD_POINTS=$(echo "$LINE" | cut -d'|' -f3 | tr -d ' ')
            OLD_FLAGS=$(echo "$LINE" | cut -d'|' -f4 | tr -d ' ')

            if [ -z "$OLD_POINTS" ]; then
              OLD_POINTS=0
            fi

            NEW_POINTS=$((OLD_POINTS + POINTS))

            sed -i "\|$LINE|d" leaderboard.md
            echo "| $USER | $NEW_POINTS | $OLD_FLAGS,$FLAG |" >> leaderboard.md
          else
            echo "| $USER | $POINTS | $FLAG |" >> leaderboard.md
          fi

      # -----------------------------
      # Commit leaderboard
      # -----------------------------
      - name: Commit Leaderboard
        if: steps.validate.outputs.valid == 'true' && steps.dup.outputs.dup == 'false'
        run: |
          git config user.name "ctf-bot"
          git config user.email "ctf-bot@github.com"
          git add leaderboard.md
          git commit -m "CTF: ${{ steps.extract.outputs.user }} solved ${{ steps.extract.outputs.flag }}"
          git push

      # -----------------------------
      # Comment result on issue
      # -----------------------------
      - name: Comment Result
        run: |
          if [[ "${{ steps.validate.outputs.valid }}" != "true" ]]; then
            COMMENT="❌ Wrong flag. Try again."
          elif [[ "${{ steps.dup.outputs.dup }}" == "true" ]]; then
            COMMENT="⚠️ Flag already submitted."
          else
            COMMENT="✅ Correct flag! Points added to leaderboard."
          fi

          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            -d "{\"body\":\"$COMMENT\"}"

      # -----------------------------
      # Close the issue
      # -----------------------------
      - name: Close Issue
        run: |
          curl -X PATCH \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }} \
            -d '{"state":"closed"}'
